# ğŸ” Where Is The Layout Process in Docling?

## ğŸ“Š COMPLETE DOCLING PIPELINE - WITH LAYOUT PROCESS HIGHLIGHTED

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         YOUR PYTHON SCRIPT                                   â”‚
â”‚                                                                              â”‚
â”‚  from docling.document_converter import DocumentConverter                   â”‚
â”‚  converter = DocumentConverter()                                            â”‚
â”‚  result = converter.convert("document.pdf")  â† You call this                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE: docling/document_converter.py                                        â”‚
â”‚  CLASS: DocumentConverter                                                   â”‚
â”‚                                                                              â”‚
â”‚  def convert(self, pdf_path):                                               â”‚
â”‚      # Loop through each page                                               â”‚
â”‚      for page_num in range(1, num_pages + 1):                               â”‚
â”‚          # Convert single page                                              â”‚
â”‚          page_result = self._convert_page(pdf_path, page_num)               â”‚
â”‚      return document                                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE: docling/document_converter.py                                        â”‚
â”‚  METHOD: _convert_page()                                                    â”‚
â”‚                                                                              â”‚
â”‚  def _convert_page(self, pdf_path, page_num):                               â”‚
â”‚      # Get the PDF pipeline                                                 â”‚
â”‚      pipeline = self.get_pipeline(InputFormat.PDF)                          â”‚
â”‚                                                                              â”‚
â”‚      # Execute pipeline on this page                                        â”‚
â”‚      page_result = pipeline.execute(pdf_path, page_num)  â†â”€â”€â”              â”‚
â”‚                                                               â”‚              â”‚
â”‚      return page_result                                      â”‚              â”‚
â”‚                                                               â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                â”‚
                                                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE: docling/backend/pdf_backend.py                                       â”‚
â”‚  CLASS: StandardPdfPipeline                                                 â”‚
â”‚                                                                              â”‚
â”‚  def execute(self, pdf_path, page_num):                                     â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚ STEP 1: Extract Text Cells (PyMuPDF)                 â”‚              â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚      â”‚ cells = self._extract_cells(pdf_path, page_num)      â”‚              â”‚
â”‚      â”‚                                                       â”‚              â”‚
â”‚      â”‚ Returns: List of TextCell objects                    â”‚              â”‚
â”‚      â”‚   TextCell(text="Hello", bbox=(10,20,50,30))         â”‚              â”‚
â”‚      â”‚   TextCell(text="World", bbox=(60,20,100,30))        â”‚              â”‚
â”‚      â”‚   ... (all text on the page)                         â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â†“                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚ STEP 2: Run AI Layout Model (Granite-258M) ğŸ¯        â”‚              â”‚
â”‚      â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚              â”‚
â”‚      â”‚ â­â­â­ THIS IS THE LAYOUT DETECTION! â­â­â­            â”‚              â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚      â”‚                                                       â”‚              â”‚
â”‚      â”‚ predictions = self.layout_model.predict(              â”‚              â”‚
â”‚      â”‚     page_image,  â† Image of PDF page                 â”‚              â”‚
â”‚      â”‚     cells        â† Text cells from Step 1            â”‚              â”‚
â”‚      â”‚ )                                                     â”‚              â”‚
â”‚      â”‚                                                       â”‚              â”‚
â”‚      â”‚ # AI Model (Granite-258M) analyzes page and returns: â”‚              â”‚
â”‚      â”‚ # - Bounding boxes for layout elements               â”‚              â”‚
â”‚      â”‚ # - Labels (TEXT, SECTION_HEADER, TABLE, etc.)       â”‚              â”‚
â”‚      â”‚ # - Confidence scores                                â”‚              â”‚
â”‚      â”‚                                                       â”‚              â”‚
â”‚      â”‚ Returns: List of Cluster objects (RAW AI output)     â”‚              â”‚
â”‚      â”‚   Cluster(id=1, label=TEXT, bbox=..., conf=0.87)     â”‚              â”‚
â”‚      â”‚   Cluster(id=2, label=SECTION_HEADER, bbox=...,      â”‚              â”‚
â”‚      â”‚           conf=0.52)                                  â”‚              â”‚
â”‚      â”‚   Cluster(id=3, label=TABLE, bbox=..., conf=0.91)    â”‚              â”‚
â”‚      â”‚   ... (AI predictions for entire page)               â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â†“                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚ STEP 3: Post-Process Layout ğŸ¯                       â”‚              â”‚
â”‚      â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚              â”‚
â”‚      â”‚ â­â­â­ THIS IS WHERE WE INJECT! â­â­â­                â”‚              â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚      â”‚                                                       â”‚              â”‚
â”‚      â”‚ processed_clusters, processed_cells =                â”‚              â”‚
â”‚      â”‚     LayoutPostprocessor(                             â”‚              â”‚
â”‚      â”‚         page=page,                                   â”‚              â”‚
â”‚      â”‚         clusters=predictions,  â† Raw AI clusters     â”‚              â”‚
â”‚      â”‚         options=pipeline_options                     â”‚              â”‚
â”‚      â”‚     ).postprocess()  â† Calls our patched method!     â”‚              â”‚
â”‚      â”‚                                                       â”‚              â”‚
â”‚      â”‚ # This cleans up AI predictions:                     â”‚              â”‚
â”‚      â”‚ # - Filters low confidence                           â”‚              â”‚
â”‚      â”‚ # - Removes overlapping boxes                        â”‚              â”‚
â”‚      â”‚ # - Assigns text cells to clusters                   â”‚              â”‚
â”‚      â”‚ # - ğŸµ OUR MONKEY PATCH RUNS HERE!                   â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â†“                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚ STEP 4: Extract Table Structure (if enabled)         â”‚              â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚      â”‚ table_data = self.table_model.extract(               â”‚              â”‚
â”‚      â”‚     table_clusters                                   â”‚              â”‚
â”‚      â”‚ )                                                     â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â†“                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚ STEP 5: OCR (if enabled)                             â”‚              â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚      â”‚ ocr_text = self.ocr_model.extract(image_regions)     â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â†“                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚ STEP 6: Build Document Structure                     â”‚              â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚      â”‚ document = self._build_document(processed_clusters)  â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                              â”‚
â”‚      return page_result                                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ZOOM IN: The Layout Process (Step 2 & 3)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAYOUT DETECTION & POST-PROCESSING                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 2: AI Layout Model (Granite-258M)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE: docling/models/layout_model.py                                       â”‚
â”‚  CLASS: LayoutModel                                                         â”‚
â”‚                                                                              â”‚
â”‚  def predict(self, page_image, cells):                                      â”‚
â”‚      """                                                                    â”‚
â”‚      AI model analyzes page layout                                          â”‚
â”‚      """                                                                    â”‚
â”‚                                                                              â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ INPUT:                                                  â”‚            â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€                                                   â”‚            â”‚
â”‚      â”‚ â€¢ page_image = PNG image of PDF page                   â”‚            â”‚
â”‚      â”‚ â€¢ cells = [TextCell(text, bbox), ...]                  â”‚            â”‚
â”‚      â”‚                                                         â”‚            â”‚
â”‚      â”‚         Page Image:                                     â”‚            â”‚
â”‚      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚            â”‚
â”‚      â”‚         â”‚ INFORME DE ANÃLISIS       â”‚ â† Title          â”‚            â”‚
â”‚      â”‚         â”‚                           â”‚                  â”‚            â”‚
â”‚      â”‚         â”‚ 1. DESCRIPCIÃ“N            â”‚ â† Heading        â”‚            â”‚
â”‚      â”‚         â”‚                           â”‚                  â”‚            â”‚
â”‚      â”‚         â”‚ Este documento presenta   â”‚ â† Text           â”‚            â”‚
â”‚      â”‚         â”‚ el anÃ¡lisis de la falla.  â”‚                  â”‚            â”‚
â”‚      â”‚         â”‚                           â”‚                  â”‚            â”‚
â”‚      â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”   â”‚ â† Table          â”‚            â”‚
â”‚      â”‚         â”‚ â”‚ A    â”‚ B    â”‚ C    â”‚   â”‚                  â”‚            â”‚
â”‚      â”‚         â”‚ â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤   â”‚                  â”‚            â”‚
â”‚      â”‚         â”‚ â”‚ 1    â”‚ 2    â”‚ 3    â”‚   â”‚                  â”‚            â”‚
â”‚      â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜   â”‚                  â”‚            â”‚
â”‚      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                           â†“                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ AI MODEL PROCESSING:                                   â”‚            â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚            â”‚
â”‚      â”‚                                                         â”‚            â”‚
â”‚      â”‚ # Granite-258M (IBM's 258M parameter model)            â”‚            â”‚
â”‚      â”‚ # Trained on millions of documents                     â”‚            â”‚
â”‚      â”‚                                                         â”‚            â”‚
â”‚      â”‚ 1. Convert image to features (CNN)                     â”‚            â”‚
â”‚      â”‚ 2. Detect layout regions (Transformer)                 â”‚            â”‚
â”‚      â”‚ 3. Classify each region (11 types)                     â”‚            â”‚
â”‚      â”‚ 4. Generate bounding boxes                             â”‚            â”‚
â”‚      â”‚ 5. Assign confidence scores                            â”‚            â”‚
â”‚      â”‚                                                         â”‚            â”‚
â”‚      â”‚ Types detected:                                        â”‚            â”‚
â”‚      â”‚   â€¢ text                                               â”‚            â”‚
â”‚      â”‚   â€¢ section_header                                     â”‚            â”‚
â”‚      â”‚   â€¢ title                                              â”‚            â”‚
â”‚      â”‚   â€¢ table                                              â”‚            â”‚
â”‚      â”‚   â€¢ picture                                            â”‚            â”‚
â”‚      â”‚   â€¢ list_item                                          â”‚            â”‚
â”‚      â”‚   â€¢ caption                                            â”‚            â”‚
â”‚      â”‚   â€¢ formula                                            â”‚            â”‚
â”‚      â”‚   â€¢ page_header                                        â”‚            â”‚
â”‚      â”‚   â€¢ page_footer                                        â”‚            â”‚
â”‚      â”‚   â€¢ footnote                                           â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                           â†“                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ OUTPUT (Raw AI Predictions):                           â”‚            â”‚
â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚            â”‚
â”‚      â”‚                                                         â”‚            â”‚
â”‚      â”‚ clusters = [                                           â”‚            â”‚
â”‚      â”‚   Cluster(                                             â”‚            â”‚
â”‚      â”‚     id=1,                                              â”‚            â”‚
â”‚      â”‚     label=DocItemLabel.TITLE,                          â”‚            â”‚
â”‚      â”‚     bbox=BoundingBox(l=50, t=50, r=500, b=80),         â”‚            â”‚
â”‚      â”‚     confidence=0.92,                                   â”‚            â”‚
â”‚      â”‚     cells=[]  â† Not assigned yet!                      â”‚            â”‚
â”‚      â”‚   ),                                                   â”‚            â”‚
â”‚      â”‚   Cluster(                                             â”‚            â”‚
â”‚      â”‚     id=2,                                              â”‚            â”‚
â”‚      â”‚     label=DocItemLabel.SECTION_HEADER,                 â”‚            â”‚
â”‚      â”‚     bbox=BoundingBox(l=50, t=120, r=400, b=145),       â”‚            â”‚
â”‚      â”‚     confidence=0.87,                                   â”‚            â”‚
â”‚      â”‚     cells=[]                                           â”‚            â”‚
â”‚      â”‚   ),                                                   â”‚            â”‚
â”‚      â”‚   Cluster(                                             â”‚            â”‚
â”‚      â”‚     id=3,                                              â”‚            â”‚
â”‚      â”‚     label=DocItemLabel.TEXT,                           â”‚            â”‚
â”‚      â”‚     bbox=BoundingBox(l=50, t=160, r=520, b=220),       â”‚            â”‚
â”‚      â”‚     confidence=0.91,                                   â”‚            â”‚
â”‚      â”‚     cells=[]                                           â”‚            â”‚
â”‚      â”‚   ),                                                   â”‚            â”‚
â”‚      â”‚   Cluster(                                             â”‚            â”‚
â”‚      â”‚     id=4,                                              â”‚            â”‚
â”‚      â”‚     label=DocItemLabel.TABLE,                          â”‚            â”‚
â”‚      â”‚     bbox=BoundingBox(l=50, t=240, r=450, b=340),       â”‚            â”‚
â”‚      â”‚     confidence=0.95,                                   â”‚            â”‚
â”‚      â”‚     cells=[]                                           â”‚            â”‚
â”‚      â”‚   ),                                                   â”‚            â”‚
â”‚      â”‚   ... more clusters ...                                â”‚            â”‚
â”‚      â”‚ ]                                                      â”‚            â”‚
â”‚      â”‚                                                         â”‚            â”‚
â”‚      â”‚ âš ï¸ Problems with raw AI output:                        â”‚            â”‚
â”‚      â”‚   â€¢ Some low confidence predictions                    â”‚            â”‚
â”‚      â”‚   â€¢ Overlapping bounding boxes                         â”‚            â”‚
â”‚      â”‚   â€¢ Cells not assigned to clusters yet                 â”‚            â”‚
â”‚      â”‚   â€¢ Missed some numbered titles (like "1.1")           â”‚            â”‚
â”‚      â”‚   â€¢ May have false positives                           â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  return clusters  # Raw AI predictions                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
                                 â†“
                     Raw AI clusters need cleaning!
                                 â†“
                                 â–¼

STEP 3: Layout Post-Processing (LayoutPostprocessor)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE: docling/utils/layout_postprocessor.py                                â”‚
â”‚  CLASS: LayoutPostprocessor                                                 â”‚
â”‚                                                                              â”‚
â”‚  ğŸµ â­ THIS IS WHERE THE MONKEY PATCH INTERCEPTS! â­ ğŸµ                     â”‚
â”‚                                                                              â”‚
â”‚  def __init__(self, page, clusters, options):                               â”‚
â”‚      """Initialize with raw AI predictions"""                               â”‚
â”‚      self.page = page                                                       â”‚
â”‚      self.cells = page.cells  â† Text cells from Step 1                      â”‚
â”‚      self.all_clusters = clusters  â† Raw AI predictions                     â”‚
â”‚      self.regular_clusters = [regular types]                                â”‚
â”‚      self.special_clusters = [table, picture]                               â”‚
â”‚                                                                              â”‚
â”‚  def postprocess(self):                                                     â”‚
â”‚      """Main entry point - cleans up AI predictions"""                      â”‚
â”‚                                                                              â”‚
â”‚      # Process regular clusters (text, headers, lists, etc.)                â”‚
â”‚      self.regular_clusters = self._process_regular_clusters()  ğŸ‘ˆ PATCHED!  â”‚
â”‚                                                                              â”‚
â”‚      # Process special clusters (tables, pictures)                          â”‚
â”‚      self.special_clusters = self._process_special_clusters()               â”‚
â”‚                                                                              â”‚
â”‚      # Combine and return                                                   â”‚
â”‚      final_clusters = self.regular_clusters + self.special_clusters         â”‚
â”‚      return final_clusters, self.cells                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                  ğŸµ MONKEY PATCH INTERCEPTS HERE! ğŸµ
                                 â”‚
                                 â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  METHOD: _process_regular_clusters()                                        â”‚
â”‚                                                                              â”‚
â”‚  â­ THIS METHOD DOES THE ACTUAL LAYOUT POST-PROCESSING â­                   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ WITHOUT PATCH  â”‚ WITH MONKEY PATCH                       â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚                â”‚                                         â”‚              â”‚
â”‚  â”‚ def _process_  â”‚ def _patched_process_regular_clusters(  â”‚              â”‚
â”‚  â”‚ regular_       â”‚     self                                â”‚              â”‚
â”‚  â”‚ clusters(self):â”‚ ):                                      â”‚              â”‚
â”‚  â”‚                â”‚     """Our custom version"""            â”‚              â”‚
â”‚  â”‚                â”‚                                         â”‚              â”‚
â”‚  â”‚                â”‚     # ğŸµ Step A: Run custom detector    â”‚              â”‚
â”‚  â”‚                â”‚     detector = DetailedHeadingDetector()â”‚              â”‚
â”‚  â”‚                â”‚     custom_titles = detector.detect(    â”‚              â”‚
â”‚  â”‚                â”‚         cells, page_num                 â”‚              â”‚
â”‚  â”‚                â”‚     )                                   â”‚              â”‚
â”‚  â”‚                â”‚                                         â”‚              â”‚
â”‚  â”‚                â”‚     # ğŸµ Step B: Create custom clusters â”‚              â”‚
â”‚  â”‚                â”‚     custom_clusters = []                â”‚              â”‚
â”‚  â”‚                â”‚     for title in custom_titles:         â”‚              â”‚
â”‚  â”‚                â”‚         cluster = Cluster(              â”‚              â”‚
â”‚  â”‚                â”‚             label=SECTION_HEADER,       â”‚              â”‚
â”‚  â”‚                â”‚             bbox=title['bbox'],         â”‚              â”‚
â”‚  â”‚                â”‚             confidence=0.95,            â”‚              â”‚
â”‚  â”‚                â”‚             cells=[...]                 â”‚              â”‚
â”‚  â”‚                â”‚         )                               â”‚              â”‚
â”‚  â”‚                â”‚         custom_clusters.append(cluster) â”‚              â”‚
â”‚  â”‚                â”‚                                         â”‚              â”‚
â”‚  â”‚                â”‚     # ğŸµ Step C: Merge with AI clusters â”‚              â”‚
â”‚  â”‚                â”‚     self.regular_clusters.extend(       â”‚              â”‚
â”‚  â”‚                â”‚         custom_clusters                 â”‚              â”‚
â”‚  â”‚                â”‚     )                                   â”‚              â”‚
â”‚  â”‚                â”‚                                         â”‚              â”‚
â”‚  â”‚                â”‚     # ğŸµ Step D: Call original method   â”‚              â”‚
â”‚  â”‚                â”‚     return _original_method(self)       â”‚              â”‚
â”‚  â”‚                â”‚                                         â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚                    â†“                                     â”‚              â”‚
â”‚  â”‚     DOCLING'S ORIGINAL POST-PROCESSING LOGIC            â”‚              â”‚
â”‚  â”‚     (runs on merged clusters in patched version)        â”‚              â”‚
â”‚  â”‚                                                          â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚  â”‚ Sub-step 1: Filter by confidence                   â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ clusters = [c for c in self.regular_clusters       â”‚ â”‚              â”‚
â”‚  â”‚  â”‚             if c.confidence >= threshold]          â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Remove low-confidence AI predictions             â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Keep high-confidence custom clusters (0.95)      â”‚ â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚                    â†“                                     â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚  â”‚ Sub-step 2: Apply label remapping                  â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ for cluster in clusters:                           â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     if cluster.label == TITLE:                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚         cluster.label = SECTION_HEADER             â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Standardize labels                               â”‚ â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚                    â†“                                     â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚  â”‚ Sub-step 3: Assign cells to clusters ğŸ¯            â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ for cell in self.cells:                            â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     best_cluster = find_best_overlap(cell, clusters)â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     if best_cluster:                               â”‚ â”‚              â”‚
â”‚  â”‚  â”‚         best_cluster.cells.append(cell)            â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Match text cells to layout regions               â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Custom clusters already have cells assigned!     â”‚ â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚                    â†“                                     â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚  â”‚ Sub-step 4: Handle orphaned cells                  â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ unassigned = find_unassigned_cells(clusters)       â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ for cell in unassigned:                            â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     orphan_cluster = Cluster(                      â”‚ â”‚              â”‚
â”‚  â”‚  â”‚         label=TEXT,                                â”‚ â”‚              â”‚
â”‚  â”‚  â”‚         bbox=cell.bbox,                            â”‚ â”‚              â”‚
â”‚  â”‚  â”‚         cells=[cell]                               â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     )                                              â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     clusters.append(orphan_cluster)                â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Create TEXT clusters for leftover cells          â”‚ â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚                    â†“                                     â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚  â”‚ Sub-step 5: Remove overlapping clusters            â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ for cluster_a in clusters:                         â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     for cluster_b in clusters:                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚         if overlap(a, b) > 80%:                    â”‚ â”‚              â”‚
â”‚  â”‚  â”‚             keep_best(a, b)  # Based on confidence â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Resolve conflicts between overlapping boxes      â”‚ â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚                    â†“                                     â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚  â”‚ Sub-step 6: Adjust cluster bboxes                  â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ for cluster in clusters:                           â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     # Expand bbox to contain all cells             â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     cluster.bbox = union_of_cell_bboxes(           â”‚ â”‚              â”‚
â”‚  â”‚  â”‚         cluster.cells                              â”‚ â”‚              â”‚
â”‚  â”‚  â”‚     )                                              â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ # Make bboxes match actual cell positions          â”‚ â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚                    â†“                                     â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚  â”‚ OUTPUT: Processed clusters                         â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚              â”‚
â”‚  â”‚  â”‚ return clusters  # Clean, non-overlapping, with    â”‚ â”‚              â”‚
â”‚  â”‚  â”‚                  # cells assigned                  â”‚ â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚                                                          â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ SUMMARY: Where Layout Process Happens

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    LAYOUT PROCESS LOCATION MAP                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                             â•‘
â•‘  1. PDF Input                                                               â•‘
â•‘     â†“                                                                       â•‘
â•‘  2. DocumentConverter.convert()                                            â•‘
â•‘     â””â”€â†’ For each page:                                                     â•‘
â•‘         â†“                                                                   â•‘
â•‘  3. StandardPdfPipeline.execute()                                          â•‘
â•‘     â”œâ”€â†’ Extract text cells (PyMuPDF)                                       â•‘
â•‘     â”œâ”€â†’ ğŸ¯ AI Layout Detection (Granite-258M)  â† LAYOUT ANALYSIS!         â•‘
â•‘     â”‚   â””â”€â†’ FILE: docling/models/layout_model.py                           â•‘
â•‘     â”‚       METHOD: LayoutModel.predict()                                  â•‘
â•‘     â”‚       OUTPUT: Raw AI clusters with bboxes & labels                   â•‘
â•‘     â”‚                                                                       â•‘
â•‘     â”œâ”€â†’ ğŸ¯ Layout Post-Processing  â† LAYOUT CLEANUP!                       â•‘
â•‘     â”‚   â””â”€â†’ FILE: docling/utils/layout_postprocessor.py                    â•‘
â•‘     â”‚       CLASS: LayoutPostprocessor                                     â•‘
â•‘     â”‚       METHOD: postprocess()                                          â•‘
â•‘     â”‚         â””â”€â†’ _process_regular_clusters()  ğŸµ â† MONKEY PATCH HERE!    â•‘
â•‘     â”‚             â”œâ”€â†’ Filter confidence                                    â•‘
â•‘     â”‚             â”œâ”€â†’ Remap labels                                         â•‘
â•‘     â”‚             â”œâ”€â†’ Assign cells to clusters                             â•‘
â•‘     â”‚             â”œâ”€â†’ Remove overlaps                                      â•‘
â•‘     â”‚             â””â”€â†’ Adjust bboxes                                        â•‘
â•‘     â”‚                                                                       â•‘
â•‘     â”œâ”€â†’ Table structure extraction (optional)                              â•‘
â•‘     â”œâ”€â†’ OCR (optional)                                                     â•‘
â•‘     â””â”€â†’ Build document structure                                           â•‘
â•‘         â†“                                                                   â•‘
â•‘  4. Return final document                                                   â•‘
â•‘                                                                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“ Exact File Locations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAYOUT ANALYSIS FILES IN DOCLING:                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. AI Layout Model (Detection)                                             â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚     FILE: venv/lib/python3.12/site-packages/docling/models/layout_model.py â”‚
â”‚     CLASS: LayoutModel                                                      â”‚
â”‚     METHOD: predict(page_image, cells) â†’ List[Cluster]                      â”‚
â”‚                                                                              â”‚
â”‚     What it does:                                                           â”‚
â”‚     â€¢ Loads Granite-258M model (258 million parameters)                     â”‚
â”‚     â€¢ Analyzes page image with CNN + Transformer                            â”‚
â”‚     â€¢ Detects 11 types of layout elements                                   â”‚
â”‚     â€¢ Returns bounding boxes with labels & confidence                       â”‚
â”‚                                                                              â”‚
â”‚  2. Layout Post-Processor (Cleanup) ğŸµ MONKEY PATCH TARGET                 â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚     FILE: venv/lib/python3.12/site-packages/docling/utils/                 â”‚
â”‚           layout_postprocessor.py                                           â”‚
â”‚     CLASS: LayoutPostprocessor                                              â”‚
â”‚     METHODS:                                                                â”‚
â”‚       â€¢ __init__(page, clusters, options)                                   â”‚
â”‚       â€¢ postprocess() â†’ (List[Cluster], List[TextCell])                     â”‚
â”‚       â€¢ _process_regular_clusters()  â† ğŸµ WE PATCH THIS!                   â”‚
â”‚       â€¢ _process_special_clusters()                                         â”‚
â”‚       â€¢ _assign_cells_to_clusters()                                         â”‚
â”‚       â€¢ _remove_overlapping_clusters()                                      â”‚
â”‚       â€¢ _adjust_cluster_bboxes()                                            â”‚
â”‚                                                                              â”‚
â”‚     What it does:                                                           â”‚
â”‚     â€¢ Cleans up raw AI predictions                                          â”‚
â”‚     â€¢ Filters low confidence                                                â”‚
â”‚     â€¢ Removes overlaps                                                      â”‚
â”‚     â€¢ Assigns text cells to layout regions                                  â”‚
â”‚     â€¢ ğŸµ Our monkey patch injects custom detector here!                     â”‚
â”‚                                                                              â”‚
â”‚  3. Pipeline Orchestrator                                                   â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚     FILE: venv/lib/python3.12/site-packages/docling/backend/               â”‚
â”‚           pdf_backend.py                                                    â”‚
â”‚     CLASS: StandardPdfPipeline                                              â”‚
â”‚     METHOD: execute(pdf_path, page_num)                                     â”‚
â”‚                                                                              â”‚
â”‚     What it does:                                                           â”‚
â”‚     â€¢ Orchestrates all processing steps                                     â”‚
â”‚     â€¢ Calls LayoutModel.predict()                                           â”‚
â”‚     â€¢ Calls LayoutPostprocessor.postprocess()                               â”‚
â”‚     â€¢ Combines everything into final document                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸµ Where Monkey Patch Injects

```
BEFORE MONKEY PATCH:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

StandardPdfPipeline.execute()
    â†“
LayoutModel.predict() â†’ AI clusters
    â†“
LayoutPostprocessor(clusters).postprocess()
    â†“
    _process_regular_clusters()  â† Uses Docling's original method
        â†“
        â€¢ Filter AI clusters
        â€¢ Assign cells
        â€¢ Remove overlaps
        â†“
    Return: AI clusters only (5 section headers)


WITH MONKEY PATCH:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

StandardPdfPipeline.execute()
    â†“
LayoutModel.predict() â†’ AI clusters
    â†“
LayoutPostprocessor(clusters).postprocess()
    â†“
    _process_regular_clusters()  â† Uses OUR patched method ğŸµ
        â†“
        ğŸµ Run DetailedHeadingDetector
        ğŸµ Find custom titles (8 titles)
        ğŸµ Create SECTION_HEADER clusters
        ğŸµ Merge: AI clusters + custom clusters
        â†“
        Call original Docling method
        â†“
        â€¢ Filter merged clusters
        â€¢ Assign cells (already done for custom)
        â€¢ Remove overlaps
        â†“
    Return: AI + custom clusters (18 section headers)
```

---

## ğŸ’¡ Key Insights

1. **Layout Analysis = 2 Steps**
   - **Step 1**: AI detection (Granite-258M) - finds layout regions
   - **Step 2**: Post-processing (LayoutPostprocessor) - cleans up & assigns cells

2. **Monkey Patch Intercepts Step 2**
   - Specifically: `_process_regular_clusters()` method
   - Runs BEFORE cell assignment
   - Merges custom clusters with AI clusters
   - Then calls original Docling logic

3. **Why This Location?**
   - âœ… After AI detection (we keep AI's work)
   - âœ… Before cell assignment (we can add our own clusters)
   - âœ… Inside the pipeline (affects final document)
   - âœ… Clean injection point (doesn't break Docling)

4. **What We DON'T Modify**
   - âŒ AI model (Granite-258M still runs normally)
   - âŒ Table extraction (still works)
   - âŒ OCR (still works if enabled)
   - âŒ Document structure building (still works)
   - âœ… Only inject additional title detection!
